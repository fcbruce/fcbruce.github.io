---
layout: default
title: ROC 与 AUC  
---


说来惭愧，虽然 AUC 这个值天天在用，但对其一直没有深入挖掘过，直到最近才去查阅了一些资料，解开了心中的谜团，并且纠正了之前的一些误区。


### ROC

ROC 曲线全称为 Receiver Operating Characteristic 曲线，ROC 曲线的横轴为假阳率（False Positive Rate, FPR），纵轴为真阳率（True Positive Rate, TPR）。计算公式如下：

$$  
FPR = \frac{FP}{TN + FP}
TPR = \frac{TP}{TP + FN}
$$  

等等，这两个公式怎么看上去有点眼熟，似乎与查准率（Precision）和查全率（Recall）有点像：

$$  
Precision = \frac{TP}{TP + FP}
Recall = \frac{TP}{TP + FN}
$$ 

首先搞清楚 TP、FP、TN、FN 的含义：  
TP - True Positive，真正例／真阳性，也就是我们认为是正例的，并且也确实是正例的样本  
FP - False Positive，假正例／假阳性，我们认为是正例，但实际上不是  
TN - True Negative，真负例／真阴性，我们认为是负例，并且也确实是负例的样本  
FN - False Negative，假负例／假阴性，我们认为是负例，但实际上是正例  

简单总结一下：这组合里面的 P 和 N 表示我们的预测结果，T 和 F 表示我们的预测结果的对错。  
举个例子：某个病人去医院检查，如果他确实得了某种疾病，并且医院检测出他得了这种疾病，那么他是真阳性，但医院没检测出来，那么他是假阴性；
如果他本身确实没有这种疾病，但医院误诊出他得了这种病，那么他是假阳性，但如果医院检测出他很健康，确实没有得病，那么他是真阴性。

那么查准率和查全率该如何理解呢？  
什么是查准率，我认为是正例中，确实为正例的有多少呢，我查出来的到底准不准呢，这时候就要用查准率来评估。  
查全率又是什么，真实为正例的样本中，被我查出正例的有有多少，我查的全不全，这就是查全率。  

搞清楚了查准率和查全率，我们再来看下真阳率和假阳率。  
真阳率和查全率，或者说和召回率是一个东西，实际上是正例中，被检测出来的百分比。
假阳率，实际上是负例，但被检测成正例的百分比。比如有 1000 个人本身没有病，但有 1 个倒霉蛋被误诊出绝症，那么这时候假阳率为 $$ 0.1% $$ 。  

假设我们一共有 $$ P + N $$ 个样本，其中 P 个是正例，N 个是负例。  
如果我们对样本的预测值是个为正例的概率，我们按这个概率排序，按从大到小的顺序遍历，那么每次我们都可以计算出一对 FPR 和 TPR。
在坐标系中打点，最后将这些点连起来，就得到了 ROC 曲线。
如果某个分类器的 ROC 曲线完全将另外一个曲线包住，那么我们可以说这个分类器比另一个要好。


### AUC  

AUC 全称为 Area Under the Curve，即曲线下面积，这里的“曲线”当然指的是 ROC 曲线，AUC 取值范围是 $$ [0, 1] $$，但实际上它的范围会在 $$ [0.5, 1] $$。
因为如果 AUC 小于 0.5，只要将预测值“反转”，就能得到一个比原来更好的分类器。但如果出现这种情况，可能需要检查一下哪里出错了。
记得曾经有个面试者和我说，参加某个比赛，用 LR 训练了一个模型试验一下，没调参，AUC 0.3，觉得还挺有效的，调了一下高了一点点，感觉还不错 :(  

显然我们对 ROC 做积分就可以算出 AUC 的值。

事实上，有个更简单的方法绘制 ROC 曲线：
将纵轴按 $$ \frac{1}{P} $$ 画刻度，横轴按 $$ \frac{1}{N} $$ 画刻度。起点为 $$ (0, 0) $$，从大到小的顺序遍历样本，遇到正例向上走一步，遇到负例横着走。走完最终会到 $$ (1, 1) $$。
那么计算 AUC 也很容易了：
```python
import numpy as np

def auc(y_true, y_pred):
    P = np.sum(y_true)
    N = len(y_true) - P
    cell = 1. / (P * N)
    area = 0
    bin_area = 0
    for label, score in sorted(zip(y_true, y_pred), key=lambda x: x[1], reverse=True):
        bin_area += cell if label else 0
        area += bin_area if not label else 0
    return area
```


### Advantage  

AUC 值有一个好处，就是在正负样本比例变化的时候，它能基本保持不变。但这其实有一个前提：样本充分且采样随机。  
我们不妨这样考虑：我们把正样本全部复制一遍，按照上面的计算方式，纵轴刻度变为 $$ \frac{1}{2P} $$。
遇到正样本向上走一步，现在的一步相当与原来的半步，但因为把正样本复制了一遍，所以走出的路线，即 ROC 曲线，会和之前重合，那么 AUC 值也就一样了。  

但如果采样不随机呢，比如丢弃一部分排序靠前的正样本，通常情况下 AUC 值会降低。这也是笔者经常遇到的情况，之前一直简单地认为是正负样本比例的影响，现在发现并不是。

---
参考资料：  
[1]. [Hulu机器学习问题与解答系列 | 第一弹：模型评估](https://mp.weixin.qq.com/s/1J0gHSNszjgoxR0Bp0m7ow)  
[2]. 机器学习/周志华著. -北京：清华大学出版社，2016.
